<body>

<!-- Intro -->
<section id="intro-screen" class="screen center">
  <video id="introVideo" src="assets/video/logo-intipixel.mp4" playsinline autoplay muted></video>
  <div class="row" style="margin-top:12px;">
    <button id="btnSkipIntro" class="btn btn-primary">SALTAR INTRO</button>
  </div>
</section>

<!-- Login -->
<section id="login-screen" class="screen center" style="display:none;">
  <div class="modal">
    <h3>Inicio de Sesi√≥n</h3>
    <p class="subtitle">Ingresa tu Nick / Perfil</p>
    <input id="nickInput" class="input" placeholder="Nick / Perfil" />
    <div class="row" style="margin-top:12px;">
      <button id="btnLogin" class="btn btn-primary">ENTRAR AL JUEGO</button>
    </div>
  </div>
</section>

<!-- Selecci√≥n de Avatar -->
<section id="avatar-screen" class="screen center" style="display:none;">
  <div class="modal">
    <h3>Elige tu Guerrero</h3>
    <div id="avatarGrid" class="grid mode-avatars">
      <div class="card"><img src="assets/img/guerrero-condor.png" alt="C√≥ndor" data-avatar="condor"></div>
      <div class="card"><img src="assets/img/guerrero-puma.png" alt="Puma" data-avatar="puma"></div>
      <div class="card"><img src="assets/img/guerrero-boa.png" alt="Boa" data-avatar="boa"></div>
      <div class="card"><img src="assets/img/guerrero-vicuna.png" alt="Vicu√±a" data-avatar="vicuna"></div>
    </div>
    <div class="row" style="margin-top:12px;">
      <button id="btnAvatarContinue" class="btn btn-primary">Continuar</button>
    </div>
  </div>
</section>

<!-- Modos de juego -->
<section id="mode-screen" class="screen center" style="display:none;">
  <div class="modal">
    <h3>SELECCIONA EL MODO DE JUEGO</h3>
    <div class="grid mode-avatars">
      <div class="card"><img src="assets/img/modos/1C1.png" alt="1 vs 1" data-mode="1v1"></div>
      <div class="card"><img src="assets/img/modos/1cIA.png" alt="1 vs IA" data-mode="1vIA"></div>
      <div class="card"><img src="assets/img/modos/3g.png" alt="3 guerreros" data-mode="3g"></div>
      <div class="card"><img src="assets/img/modos/4g.png" alt="4 guerreros" data-mode="4g"></div>
    </div>
    <div class="row" style="margin-top:12px;">
      <button id="btnModeContinue" class="btn btn-primary">Continuar</button>
    </div>
  </div>
</section>

<!-- Tiempo por turno -->
<section id="time-screen" class="screen center" style="display:none;">
  <div class="modal">
    <h3>Tiempo por Turno</h3>
    <div class="grid">
      <div class="card"><img src="assets/img/times/st.png" alt="Sin tiempo" data-time="st"></div>
      <div class="card"><img src="assets/img/times/5s.png" alt="5s" data-time="5s"></div>
      <div class="card"><img src="assets/img/times/10s.png" alt="10s" data-time="10s"></div>
      <div class="card"><img src="assets/img/times/15s.png" alt="15s" data-time="15s"></div>
    </div>
    <div class="row" style="margin-top:12px;">
      <button id="btnTimeContinue" class="btn btn-primary">Continuar</button>
    </div>
  </div>
</section>

<!-- Selecci√≥n de Fase -->
<section id="phase-screen" class="screen center" style="display:none;">
  <div class="modal">
    <h3>Selecciona Fase</h3>
    <p>Copas actuales: <span id="cupsCount">0</span></p>
    <div class="grid" id="phaseGrid"><!-- JS crear√° botones Fase 1..12 --></div>
    <div class="row" style="margin-top:12px;">
      <button id="btnPhaseContinue" class="btn btn-primary">Continuar</button>
    </div>
  </div>
</section>

<!-- Preparando tablero -->
<section id="prep-screen" class="screen center" style="display:none;">
  <div class="modal">
    <h3>Preparando tablero‚Ä¶</h3>
    <p>Fase <span id="prepPhase">‚Äî</span></p>
  </div>
</section>

<!-- Juego -->
<section id="game-screen" class="screen" style="display:none;">
  <!-- HUD superior -->
  <div id="hud">
    <div class="wrap">
      <div class="stats">
        <span class="pill" id="statCoins">üí∞ 0</span>
        <span class="pill" id="statCups">üèÜ 0</span>
        <span class="pill" id="statScore">üéØ 0</span>
      </div>
      <div class="actions">
        <button id="btnStore" class="btn btn-primary">üõí Tienda</button>
        <button id="btnSettings" class="btn btn-secondary">‚öô Ajustes</button>
        <button id="btnRules" class="btn btn-secondary">üìú Reglas</button>
        <button id="btnLogout" class="btn btn-ghost">Cerrar sesi√≥n</button>
      </div>
    </div>
  </div>

  <!-- Tablero -->
  <div class="center" style="padding:16px;">
    <canvas id="gameCanvas" width="640" height="640"></canvas>
  </div>

  <!-- Control inferior -->
  <div class="center">
    <button id="btnFinish" class="btn btn-primary">Finalizar</button>
  </div>
</section>

<!-- Resumen de partida -->
<section id="resumen-game-screen" class="screen center" style="display:none;">
  <div class="modal">
    <h3>Resumen de la partida</h3>
    <div class="card" id="matchSummary"></div>
    <button id="btnResumenContinue" class="btn btn-primary" style="margin-top:12px;">Continuar</button>
  </div>
</section>

<!-- Puntaje/Avatar -->
<section id="player-game-score" class="screen center" style="display:none;">
  <div class="modal">
    <h3>Resumen de avatar</h3>
    <div class="card" id="playerScore"></div>
    <button id="btnScoreContinue" class="btn btn-primary" style="margin-top:12px;">Continuar</button>
  </div>
</section>

<!-- Fin (Victoria/Derrota) -->
<section id="end-screen" class="screen center" style="display:none;">
  <div class="modal">
    <h2 id="endTitle">¬°Victoria!</h2>
    <video id="endVideo" playsinline muted></video>
    <div class="row" style="margin-top:12px;">
      <button id="btnPlayAgain" class="btn btn-primary">Jugar otra fase</button>
    </div>
  </div>
</section>

<!-- Modal de Tienda -->
<div id="storeModal" class="modal-screen">
  <div class="modal">
    <h3>Tienda</h3>
    <div class="content">
      <div class="grid">
        <div class="card">
          <img src="assets/img/store/bombas.png" alt="Bombas">
          <button data-buy="bomb" class="btn btn-primary">üí£ Comprar (100)</button>
        </div>
        <div class="card">
          <img src="assets/img/store/rayos.png" alt="Rayos">
          <button data-buy="ray" class="btn btn-primary">‚ö° Comprar (120)</button>
        </div>
        <div class="card">
          <img src="assets/img/store/skin-condor.png" alt="Skin C√≥ndor">
          <button data-buy="skin-condor" class="btn btn-secondary">‚ú® Comprar (500)</button>
        </div>
        <div class="card">
          <img src="assets/img/store/skin-puma.png" alt="Skin Puma">
          <button data-buy="skin-puma" class="btn btn-secondary">‚ú® Comprar (500)</button>
        </div>
      </div>
      <button id="btnCloseStore" class="btn btn-ghost">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal de Reglas -->
<div id="rulesModal" class="modal-screen">
  <div class="modal">
    <h3>Reglas</h3>
    <div class="content" style="text-align:left;">
      <p><strong>Objetivo:</strong> Conquista la Chakana sumando puntos por l√≠neas formadas y control de casillas.</p>
      <p><strong>Puntuaci√≥n:</strong> Casillas claras (1), intermedias (2), oscuras (4) seg√∫n patr√≥n; formar l√≠neas suma puntos adicionales.</p>
      <p><strong>Tiempo:</strong> Sin tiempo, 5s, 10s, 15s por turno seg√∫n selecci√≥n.</p>
      <p><strong>Power-ups:</strong> Bombas (üí£) y Rayos (‚ö°) se compran en Tienda y afectan el tablero seg√∫n reglas internas.</p>
    </div>
    <button id="btnCloseRules" class="btn btn-ghost">Cerrar</button>
  </div>
</div>

<!-- Tema (opcional, inicia en oscuro) -->
<link id="theme-link" rel="stylesheet" href="assets/css/chakana-theme-dark.css">

<!-- Tu lector de patrones desde imagen -->
<script src="chakana-phase-from-images.js"></script>

<!-- Controlador del juego (inline para facilitar) -->
<script>
/* -----------------------------------------
   Conquista de la Chakana ‚Äî App Controller
   Flujo de escenas, tablero desde imagen,
   IA con brillo 2s, Tienda, Reglas, Logout,
   Selector de Tema Claro/Oscuro
----------------------------------------- */

// Estado m√≠nimo
const state = {
  nick: '',
  avatar: null,   // 'condor' | 'puma' | 'boa' | 'vicuna'
  mode: null,     // '1v1' | '1vIA' | '3g' | '4g'
  time: null,     // 'st' | '5s' | '10s' | '15s'
  phaseId: 1,
  cups: 0,
  coins: 0,
  score: 0,
  matrix: null,
  n: null
};

// Navegaci√≥n de pantallas
const screens = [
  'intro-screen','login-screen','avatar-screen','mode-screen','time-screen',
  'phase-screen','prep-screen','game-screen','resumen-game-screen','player-game-score','end-screen'
];
function showScreen(id) {
  screens.forEach(s => {
    const el = document.getElementById(s);
    if (el) { el.style.display = 'none'; el.classList.remove('fade-in'); }
  });
  const el = document.getElementById(id);
  if (el) { el.style.display = 'block'; el.classList.add('fade-in'); }
}
function go(id){ showScreen(id); }

// Intro: al terminar el video, ir a Login
document.getElementById('introVideo')?.addEventListener('ended', () => go('login-screen'));
document.getElementById('btnSkipIntro')?.addEventListener('click', () => go('login-screen'));

// Login
document.getElementById('btnLogin')?.addEventListener('click', () => {
  const nick = document.getElementById('nickInput').value.trim();
  state.nick = nick || 'Jugador';
  // Bonus de tutorial (aj√∫stalo cuando conectes el evento real del video)
  // state.coins += 300;
  go('avatar-screen');
});

// Avatar
document.getElementById('avatarGrid')?.addEventListener('click', (e) => {
  const t = e.target.closest('img[data-avatar]');
  if (!t) return;
  document.querySelectorAll('#avatarGrid img').forEach(img => img.classList.remove('selected','selectable'));
  t.classList.add('selected','selectable');
  state.avatar = t.dataset.avatar;
});
document.getElementById('btnAvatarContinue')?.addEventListener('click', () => {
  if (!state.avatar) return alert('Elige un guerrero');
  go('mode-screen');
});

// Modo
document.querySelector('#mode-screen .grid')?.addEventListener('click', (e) => {
  const t = e.target.closest('img[data-mode]');
  if (!t) return;
  document.querySelectorAll('#mode-screen img').forEach(img => img.classList.remove('selected','selectable'));
  t.classList.add('selected','selectable');
  state.mode = t.dataset.mode;
});
document.getElementById('btnModeContinue')?.addEventListener('click', () => {
  if (!state.mode) return alert('Selecciona modo');
  go('time-screen');
});

// Tiempo
document.querySelector('#time-screen .grid')?.addEventListener('click', (e) => {
  const t = e.target.closest('img[data-time]');
  if (!t) return;
  document.querySelectorAll('#time-screen img').forEach(img => img.classList.remove('selected','selectable'));
  t.classList.add('selected','selectable');
  state.time = t.dataset.time;
});
document.getElementById('btnTimeContinue')?.addEventListener('click', () => {
  if (!state.time) return alert('Selecciona tiempo');
  buildPhaseGrid();
  go('phase-screen');
});

// Fases
function buildPhaseGrid(){
  const wrap = document.getElementById('phaseGrid');
  wrap.innerHTML = '';
  const { PHASE_IMAGE_MAP } = window.ChakanaPhaseFromImages;
  Object.keys(PHASE_IMAGE_MAP).forEach(id => {
    const b = document.createElement('button');
    b.className = 'btn btn-secondary';
    b.textContent = `Fase ${id}`;
    b.dataset.phaseId = id;
    wrap.appendChild(b);
  });
  wrap.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-phaseId]');
    if (!b) return;
    wrap.querySelectorAll('button').forEach(x=>x.classList.remove('selected'));
    b.classList.add('selected');
    state.phaseId = parseInt(b.dataset.phaseId,10);
  }, { once: true });
}
document.getElementById('btnPhaseContinue')?.addEventListener('click', async () => {
  if (!state.phaseId) return alert('Selecciona fase');
  document.getElementById('prepPhase').textContent = String(state.phaseId);
  go('prep-screen');
  setTimeout(async () => {
    await cargarFaseYTablero(state.phaseId);
    go('game-screen');
  }, 1500);
});

// Cargar matriz y renderizar tablero
async function cargarFaseYTablero(faseId){
  const { PHASE_IMAGE_MAP, extractMatrixFromImage } = window.ChakanaPhaseFromImages;
  const fase = PHASE_IMAGE_MAP[faseId];
  if (!fase) { alert('Fase inv√°lida'); return; }
  try {
    const matrix = await extractMatrixFromImage(fase.src, fase.n);
    state.matrix = matrix;
    state.n = fase.n;
    renderBoard(matrix, fase.n);
    actualizarHUD();
  } catch (err) {
    console.error(err);
    alert('Error cargando la fase. Abre el juego v√≠a HTTP/HTTPS.');
  }
}

// Render del tablero en canvas usando tus variables CSS
function renderBoard(matrix, n){
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  const tile = Math.floor(Math.min(W,H)/n);
  const css = getComputedStyle(document.documentElement);
  const colors = {
    1: css.getPropertyValue('--pastel-green').trim() || '#b7e1a1',
    2: css.getPropertyValue('--yellow').trim() || '#f3da83',
    4: css.getPropertyValue('--dark-brown').trim() || '#8b5a2b'
  };
  for (let r=0; r<n; r++){
    for (let c=0; c<n; c++){
      const val = matrix[r][c];
      ctx.fillStyle = colors[val] || '#ccc';
      ctx.fillRect(c*tile, r*tile, tile-1, tile-1);
    }
  }
  // Rejilla sutil
  ctx.strokeStyle = '#5a4f47';
  for (let i=0; i<=n; i++){
    ctx.beginPath(); ctx.moveTo(0, i*tile); ctx.lineTo(n*tile, i*tile); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(i*tile, 0); ctx.lineTo(i*tile, n*tile); ctx.stroke();
  }
}

// HUD y acciones
function actualizarHUD(){
  document.getElementById('hud').style.display = 'block';
  document.getElementById('statCoins').textContent = `üí∞ ${state.coins}`;
  document.getElementById('statCups').textContent  = `üèÜ ${state.cups}`;
  document.getElementById('statScore').textContent = `üéØ ${state.score}`;
}

// Finalizar ‚Üí Resumen
document.getElementById('btnFinish')?.addEventListener('click', () => {
  const el = document.getElementById('matchSummary');
  el.innerHTML = `<p>Jugador: ${state.nick}</p><p>Modo: ${state.mode}</p><p>Tiempo: ${state.time}</p><p>Fase: ${state.phaseId}</p><p>Puntuaci√≥n: ${state.score}</p>`;
  go('resumen-game-screen');
});

document.getElementById('btnResumenContinue')?.addEventListener('click', () => {
  const el = document.getElementById('playerScore');
  const victoria = Math.random() > 0.5; // reemplaza por tu l√≥gica real
  if (victoria) { state.cups += 1; state.coins += 50; }
  else { state.cups = Math.max(0, state.cups - 1); }
  el.innerHTML = `<p>Monedas: ${state.coins}</p><p>Copas: ${state.cups}</p>`;
  go('end-screen');
  playEndVideoByAvatar(victoria);
});

// End: video seg√∫n avatar
function playEndVideoByAvatar(victory){
  const v = document.getElementById('endVideo');
  const a = state.avatar || 'condor';
  const kind = victory ? 'win' : 'los';
  v.src = `assets/video/${a}-${kind}.mp4`;
  v.play().catch(()=>{ /* silencioso */ });
}
document.getElementById('btnPlayAgain')?.addEventListener('click', () => go('phase-screen'));

// Tienda (Store)
const storeModal = document.getElementById('storeModal');
document.getElementById('btnStore')?.addEventListener('click', () => storeModal.style.display = 'flex');
document.getElementById('btnCloseStore')?.addEventListener('click', () => storeModal.style.display = 'none');
storeModal?.addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-buy]');
  if (!b) return;
  const item = b.dataset.buy;
  const price = item.startsWith('skin') ? 500 : (item === 'ray' ? 120 : 100);
  if (state.coins >= price){ state.coins -= price; actualizarHUD(); alert(`Comprado: ${item}`); }
  else alert('Monedas insuficientes');
});

// Reglas (modal)
const rulesModal = document.getElementById('rulesModal');
document.getElementById('btnRules')?.addEventListener('click', () => rulesModal.style.display = 'flex');
document.getElementById('btnCloseRules')?.addEventListener('click', () => rulesModal.style.display = 'none');

// Cerrar sesi√≥n ‚Üí login
document.getElementById('btnLogout')?.addEventListener('click', () => {
  Object.assign(state, { nick:'', avatar:null, mode:null, time:null, phaseId:1, matrix:null, n:null, score:0 });
  document.getElementById('hud').style.display = 'none';
  go('login-screen');
});

// Selector de Tema (desde Ajustes)
document.getElementById('btnSettings')?.addEventListener('click', () => {
  const useLight = confirm('¬øCambiar a Tema Claro Dorado?\n(OK = Claro, Cancel = Oscuro)');
  setTheme(useLight ? 'assets/css/chakana-theme-light.css' : 'assets/css/chakana-theme-dark.css');
});
function setTheme(href){
  let link = document.getElementById('theme-link');
  if (!link){
    link = document.createElement('link');
    link.rel = 'stylesheet';
    link.id = 'theme-link';
    document.head.appendChild(link);
  }
  link.href = href;
}

// IA: jugada y brillo 2s (modo 1 vs IA)
function aiPlaceMove() {
  if (state.mode !== '1vIA' || !state.matrix || !state.n) return;
  const n = state.n;
  let target = null;
  // Prioriza valor 2; si no hay, toma valor 1
  for (let r = 0; r < n && !target; r++)
    for (let c = 0; c < n && !target; c++)
      if (state.matrix[r][c] === 2) target = {r, c};
  if (!target) {
    for (let r = 0; r < n && !target; r++)
      for (let c = 0; c < n && !target; c++)
        if (state.matrix[r][c] === 1) target = {r, c};
  }
  if (!target) return;

  // Redibuja tablero (si tu jugada modifica algo, hazlo aqu√≠)
  renderBoard(state.matrix, n);

  // Resalta (parpadeo 2s) la celda jugada por IA
  highlightCells([target], n);
}

// Brillo parpadeante 2s sobre celdas
function highlightCells(cells, n) {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const tile = Math.floor(Math.min(W, H) / n);
  let start = null;
  const duration = 2000; // 2s

  function frame(ts) {
    if (!start) start = ts;
    const elapsed = ts - start;
    const t = Math.min(elapsed / duration, 1);
    renderBoard(state.matrix, n);

    const gold = getComputedStyle(document.documentElement).getPropertyValue('--gold').trim() || '#f0c23b';
    const alpha = 0.6 * Math.abs(Math.sin(elapsed / 180));

    cells.forEach(({r, c}) => {
      const x = c * tile, y = r * tile;
      const grad = ctx.createRadialGradient(
        x + tile/2, y + tile/2, 4,
        x + tile/2, y + tile/2, tile/1.2
      );
      grad.addColorStop(0, hexToRgba(gold, alpha));
      grad.addColorStop(1, hexToRgba('#000000', 0));
      ctx.fillStyle = grad;
      ctx.fillRect(x, y, tile, tile);
      ctx.lineWidth = 3;
      ctx.strokeStyle = hexToRgba(gold, Math.min(0.85, alpha + 0.25));
      ctx.strokeRect(x + 1.5, y + 1.5, tile - 3, tile - 3);
    });

    if (elapsed < duration) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

// HEX ‚Üí RGBA
function hexToRgba(hex, a=1){
  const h = hex.replace('#','');
  const bigint = parseInt(h, 16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return `rgba(${r},${g},${b},${a})`;
}

// Demo: tras cualquier clic en game-screen, la IA juega si el modo es 1vIA
document.getElementById('game-screen')?.addEventListener('click', () => {
  if (state.mode === '1vIA') setTimeout(aiPlaceMove, 600);
});

// Arranque
go('intro-screen');

</script>
</body>
